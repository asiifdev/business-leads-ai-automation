const BusinessScraper = require('./scraper');
const FileUtils = require('./fileUtils');
const { getProfile, isConfigured } = require('./businessProfile');

// Parse command line arguments
function parseArguments() {
  const profile = getProfile();
  const defaultQuery = profile.preferences.defaultSearchQuery || '';

  const args = process.argv.slice(2);
  const options = {
    query: defaultQuery,
    maxResults: 20,
    generateMarketing: false,
    marketingContent: "",
    callToAction: "",
    language: profile.preferences.language || 'indonesian'
  };

  for (let i = 0; i < args.length; i++) {
    switch (args[i]) {
      case '-q':
      case '--query':
        options.query = args[i + 1];
        i++;
        break;
      case '-l':
      case '--length':
        const length = parseInt(args[i + 1]) || 20;
        options.maxResults = Math.min(length, 100); // Max 100 results
        i++;
        break;
      case '-m':
      case '--marketing':
        options.generateMarketing = true;
        options.marketingContent = args[i + 1] || "";
        i++;
        break;
      case '-c':
      case '--cta':
        options.callToAction = args[i + 1] || "";
        break;
      case '-L':
      case '--language':
        options.language = args[i + 1] || 'indonesian';
        i++;
        break;
      case '-h':
      case '--help':
        const profileStatus = isConfigured()
          ? `‚úÖ Business profile loaded: ${profile.business.name || '(name not set)'}`
          : '‚ö†Ô∏è  No business profile found. Run: npm run setup';
        console.log(`
Usage: node src/cli.js [options]

${profileStatus}

Options:
  -q, --query <string>     Search query${defaultQuery ? ` (default: "${defaultQuery}")` : ' (set via npm run setup)'}
  -l, --length <number>    Number of results to scrape (default: 20, max: 100)
  -m, --marketing <text>   Marketing content + Generate AI marketing templates
  -c, --cta <text>         Call to action (required if -m is used)
  -L, --language <lang>    Output language: indonesian / english (default: ${options.language})
  -h, --help               Show this help message

Examples:
  node index.js -q "Restaurant Jakarta" -l 50
  node index.js -q "Rental Mobil Jakarta" -l 10 -m "Your marketing content here" -c "Schedule a Free Demo"
  node index.js -q "Klinik Bandung" -l 20 -L english
        `);
        process.exit(0);
        break;
    }
  }

  return options;
}

// Main CLI function
async function main() {
  const options = parseArguments();

  if (!options.query) {
    console.log('‚ùå No search query specified.');
    console.log('   Use: node index.js -q "Your Search Query"');
    console.log('   Or run: npm run setup to configure default search query.');
    process.exit(1);
  }

  const scraper = new BusinessScraper();

  try {
    console.log(`Starting business scraper...`);
    console.log(`Query: "${options.query}"`);
    console.log(`Max Results: ${options.maxResults}`);
    console.log(`Language: ${options.language}`);
    console.log(`Generate Marketing: ${options.generateMarketing ? 'Yes' : 'No'}`);

    // Scrape with parameters
    await scraper.scrapeGoogleMaps(options.query, options.maxResults);

    // Process dan clean data
    const processedData = await scraper.processResults();

    // Save ke file
    const filename = `${options.query.replace(/\s+/g, '_').toLowerCase()}_leads`;
    const savedFiles = await FileUtils.saveToFile(processedData, filename);

    console.log(
      `\nScraping completed! Found ${processedData.length} potential leads.`
    );
    console.log(`Target: ${options.maxResults}, Actual: ${processedData.length}`);
    console.log("Leads include: all businesses (with and without websites)");

    // Generate marketing templates if requested
    if (options.generateMarketing) {
      console.log('\nü§ñ Generating AI marketing templates...');
      
      if (!options.marketingContent) {
        console.log('‚ùå Error: Marketing content (-m) is required when using marketing feature');
        return;
      }
      
      const MarketingAutomation = require('./marketing');
      const marketing = new MarketingAutomation();
      
      // Load the scraped leads
      console.log(`Loading leads from: ${savedFiles.jsonFile}`);
      const leads = await marketing.loadLeads(savedFiles.jsonFile);
      console.log(`Loaded leads type: ${typeof leads}, length: ${leads ? leads.length : 'undefined'}`);
      
      if (leads && leads.length > 0) {
        console.log(`Processing ${leads.length} leads for marketing...`);
        console.log(`Marketing Content: ${options.marketingContent.substring(0, 100)}...`);
        console.log(`Call to Action: ${options.callToAction || 'Auto-generated by AI'}`);
        
        // Generate marketing templates with custom content
        const marketingData = await marketing.generateMarketingTemplatesWithContent(
          leads, 
          options.marketingContent, 
          options.callToAction
        );
        
        if (marketingData.length > 0) {
          // Save marketing templates
          const marketingFilename = `${options.query.replace(/\s+/g, '_').toLowerCase()}_marketing`;
          await marketing.saveMarketingTemplates(marketingData, marketingFilename);
          
          console.log(`‚úÖ Generated ${marketingData.length} marketing templates`);
        } else {
          console.log('‚ö†Ô∏è No marketing templates generated (check OpenAI configuration)');
        }
      } else {
        console.log('‚ùå No leads found for marketing generation');
        console.log('Leads data:', leads);
      }
    }
  } catch (error) {
    console.error("Error in main process:", error);
  } finally {
    await scraper.close();
  }
}

// Export for testing
module.exports = { main, parseArguments };

// Run if this file is executed directly
if (require.main === module) {
  main().catch(console.error);
}